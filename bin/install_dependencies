#!/usr/bin/env bash

###
# Helper functions
##
function info () {
	printf "\r  [ \033[00;34m..\033[0m ] %s\n" "$1"
}

function success () {
	printf "\r\033[2K  [ \033[00;32mOK\033[0m ] %s\n" "$1"
}

function warn () {
  printf "\r\033[2K  [\033[0;31mWARN\033[0m] %s\n" "$1"
}

function sub_warn () {
  printf "\r\033[2K  [\033[0;31mWARN\033[0m] \t%s\n" "$1"
}

function stash_pop () {
	# Puts back the stuff that wasn't committed
	info "Git stashing: Putting back temporarily stashed files"
	git stash pop -q
}

function stash_push () {
    info "Git stashing: Stashing non-committed files temporarily"
    if git stash -q --keep-index ; then
        success "Git stashing: All non-committed files have been temporarily stashed"
    else
        warn "Git stashing: An error occurred trying to stash non-relevant files, please check for any merge conflicts"
        exit 1
    fi
}

##
# NOTE: The only reason why we have this script is because
# travis's normal environment causes tlmgr to fail miserably.
# If by chance I ever fix this, I could probably remove this
# entire script.
##

declare -A latex_dependency_packages
latex_dependency_packages[datetime2]=mirrors.ctan.org/macros/latex/contrib/datetime2.zip
latex_dependency_packages[tracklang]=mirrors.ctan.org/macros/generic/tracklang.zip
# latex_dependency_packages[fontawesome]=mirrors.ctan.org/fonts/fontawesome.zip

function install_latex_package() {
		package_name=$1
		package_download_link=$2
    info "Latex Package Install: Attempting to install ${package_name}"
		cd ~/texmf
		wget ${package_download_link}
		unzip ${package_name}.zip
		cd ${package_name}

		if [[ -f ${package_name}.ins ]]; then
			  info "Latex Package Install: Generating .sty file for ${package_name} now"
		    xelatex ${package_name}.ins

				# TODO P0: remove after
				ls

				# Moves the .sty files
				mkdir -p ../tex/latex/${package_name}
				cp *.sty ../tex/latex/${package_name}

				# Moves the .tex files
				mkdir -p ../tex/plain/${package_name}
				cp *.tex ../tex/plain/${package_name}

				# TODO P0: remove after
				ls
				ls ../tex/latex/${package_name}
				ls ../tex/plain/${package_name}

				success "Latex Package Install: Generated .sty file for ${package_name}"
		else
		    info "Latex Package Install: Copying pre-generated .sty file for ${package_name}"
				# cp tex/${package_name}.sty ../..  # TODO P0: remove after
				cp -r tex/* ../..
		    success "Latex Package Install: Copied pre-generated .sty file for ${package_name}"
		fi

		# Cleans up
		cd ..
		rm -rf ${package_name}

		success "Latex Package Install: Successfully installed ${package_name}"
}

# TODO P0: Remove after
# mkdir -p ~/texmf
#
# for latex_dependency_package in "${!latex_dependency_packages[@]}"
# do
# 	install_latex_package $latex_dependency_package ${latex_dependency_packages[$latex_dependency_package]}
# done
#
# success "Latex Package Install: Successfully compiled all dependencies"
#
# if texhash ~/texmf ; then
#     success "Latex Package Install: Successfully installed all packages into TDS"
# else
#     warning "Latex Package Install: Failed to install all packages into TDS"
# 		exit 1
# fi


# Modified from https://tex.stackexchange.com/questions/398830/how-to-build-my-latex-automatically-with-pdflatex-using-travis-ci/398831#398831

# See if there is a cached version of TL available
info "TexLive: Checking for cache version existence"
export PATH=/tmp/texlive/bin/x86_64-linux:$PATH
if ! command -v texlua > /dev/null; then
	info "TexLive: Could not be found in cache, downloading and installing now"
  # Obtain TeX Live
  wget http://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
  tar -xzf install-tl-unx.tar.gz
  cd install-tl-20*

  # Install a minimal system
  ./install-tl --profile=../bin/texlive.profile

  cd ..

	success "TexLive: Minimal texlive version was installed"
fi

success "TexLive: Successfully installed"

# Just including texlua so the cache check above works
# Needed for any use of texlua even if not testing LuaTeX
info "TexLive: Checking for the installed luatex"
tlmgr install luatex
success "TexLive: Luatex was found"

# Other contrib packages: done as a block to avoid multiple calls to tlmgr
# texlive-latex-base is needed to run pdflatex
info "TexLive: Installing dependencies"
tlmgr install   \
  datetime2     \
  tracklang     \
	xetex       \
	fontawesome
	# TODO P0: Add in fontawesome
success "TexLive: All dependencies installed"

# Keep no backups (not required, simply makes cache bigger)
info "TexLive: Disabling backups"
tlmgr option -- autobackup 0
success "TexLive: Backups are disabled"

# Update the TL install but add nothing new
info "TexLive: Updating to the latest version"
tlmgr update --self --all --no-auto-install
success "TexLive: Updated to the latest version"
